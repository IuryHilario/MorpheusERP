<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrada de Produtos</title>
    <link rel="stylesheet" href="../CSS/Entrada.css">
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            verificarLogin();
            carregarCamposDoLocalStorage();
            carregarProdutosDaTabela();
            preencherCamposComURL();
        });

        let produtos = [];

        function verificarLogin() {
            fetch('../../../Backend/verificalogin.php')
                .then(response => response.json())
                .then(data => {
                    if (!data.logado) {
                        window.location.href = '../../../index.html';
                    }
                })
                .catch(error => {
                    console.error("Erro ao verificar autenticação:", error);
                });
        }

        function preencherCamposComURL() {
            const urlParams = new URLSearchParams(window.location.search);

            const cod_Produto = urlParams.get("cod_Produto");
            const nome_Produto = urlParams.get("nome_Produto");
            const id_Fornecedor = urlParams.get("id_Fornecedor");
            const razao_Social = urlParams.get("razao_Social");

            if (cod_Produto) document.getElementById("cod_produto").value = cod_Produto;
            if (nome_Produto) document.getElementById("produto").value = nome_Produto;
            if (id_Fornecedor) document.getElementById("id_Fornecedor").value = id_Fornecedor;
            if (razao_Social) document.getElementById("razao_Social").value = razao_Social;

            
            // Limpa os parâmetros da URL
            window.history.replaceState({}, document.title, window.location.pathname);
            salvarCamposNoLocalStorage();
        }

        function salvarCamposNoLocalStorage() {
            const codProduto = document.getElementById("cod_produto").value;
            const produto = document.getElementById("produto").value;
            const idFornecedor = document.getElementById("id_Fornecedor").value;
            const razaoSocial = document.getElementById("razao_Social").value;

            // Salva apenas se houver um valor preenchido em cada campo
            if (codProduto) localStorage.setItem("cod_produto", codProduto);
            if (produto) localStorage.setItem("produto", produto);
            if (idFornecedor) localStorage.setItem("id_Fornecedor", idFornecedor);
            if (razaoSocial) localStorage.setItem("razao_Social", razaoSocial);
        }

        function carregarCamposDoLocalStorage() {
            if (localStorage.getItem("cod_produto")) {
                document.getElementById("cod_produto").value = localStorage.getItem("cod_produto");
            }
            if (localStorage.getItem("produto")) {
                document.getElementById("produto").value = localStorage.getItem("produto");
            }
            if (localStorage.getItem("id_Fornecedor")) {
                document.getElementById("id_Fornecedor").value = localStorage.getItem("id_Fornecedor");
            }
            if (localStorage.getItem("razao_Social")) {
                document.getElementById("razao_Social").value = localStorage.getItem("razao_Social");
            }
        }

        function adicionarProduto() {
            const cod_Produto = document.getElementById("cod_produto").value;
            const nome_Produto = document.getElementById("produto").value;
            const id_Fornecedor = document.getElementById("id_Fornecedor").value;
            const razao_Social = document.getElementById("razao_Social").value;
            const quantidade = document.getElementById("quantidade").value;
            const precoCusto = document.getElementById("custo").value;

                // Verifica se todos os campos estão preenchidos
            if (!cod_Produto || !nome_Produto || !id_Fornecedor || !razao_Social || !quantidade || !precoCusto) {
            document.getElementById("mensagemErro").innerText = "Preencha todos os campos antes de adicionar um produto.";
            return; // Impede que o produto seja adicionado se algum campo estiver vazio
            }

            const novoProduto = {
                cod_Produto,
                nome_Produto,
                id_Fornecedor,
                razao_Social,
                qtd_Entrada: quantidade,
                preco_Custo: precoCusto,
            };

            produtos.push(novoProduto);
            localStorage.setItem("produtosTabela", JSON.stringify(produtos)); // Salva a lista atualizada no localStorage

            document.getElementById("mensagemErro").innerText = '';
            atualizarTabela();
            limparCamposDoFormulario();
        }

        function atualizarTabela() {
            document.getElementById('resultadoTabela').style.display = 'table';
            const tabela = document.getElementById("resultadoTabela").getElementsByTagName('tbody')[0];
            tabela.innerHTML = '';

            produtos.forEach((produto) => {
                const row = tabela.insertRow();
                row.insertCell(0).textContent = produto.cod_Produto;
                row.insertCell(1).textContent = produto.nome_Produto;
                row.insertCell(2).textContent = produto.razao_Social;
                row.insertCell(3).textContent = produto.preco_Custo;
                row.insertCell(4).textContent = produto.qtd_Entrada;
            });
        }

        function carregarProdutosDaTabela() {
            const produtosSalvos = localStorage.getItem("produtosTabela");
            if (produtosSalvos) {
                produtos = JSON.parse(produtosSalvos);
                atualizarTabela();
            }
        }

        function limparCamposDoFormulario() {
            document.getElementById("cod_produto").value = '';
            document.getElementById("produto").value = '';
            document.getElementById("id_Fornecedor").value = '';
            document.getElementById("razao_Social").value = '';
            document.getElementById("quantidade").value = '';
            document.getElementById("custo").value = '';
        }

        function salvarProdutos() {
            fetch('../../../Backend/EntradaProdutos/novaentrada.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(produtos)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'sucesso') {
                    limparTabela();
                    document.getElementById('mensagemSucesso').innerText = data.mensagem;
                    setTimeout(() => {
                        location.reload();
                    }, 5000);
                } else if (data.status === 'erro') {
                    document.getElementById('mensagemErro').innerText = data.mensagem;
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                document.getElementById('mensagemErro').innerText = 'Erro ao salvar produtos.';
            });
        }

        function limparTabela() {
            produtos = []; // Limpa o array de produtos
            localStorage.removeItem("produtosTabela"); // Remove os produtos do localStorage
            atualizarTabela(); // Atualiza a tabela (vai ficar vazia)
            document.getElementById('resultadoTabela').style.display = 'none'; // Esconde a tabela vazia
        }
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Entrada de Produtos</h1>
        </div>

        <form id="entradaProdutos" class="form-container" onsubmit="event.preventDefault(); adicionarProduto();">
            <div class="form">
                <label>*Código do produto:</label>
                <div class="input-container">
                    <input type="text" id="cod_produto" class="input-field" disabled>
                    <button type="button" class="plus-icon" onclick="salvarCamposNoLocalStorage(); window.location.href='produto_pesquisa.html'">&#43;</button>
                </div>

                <label>*Produto:</label>
                <div class="input-container">
                    <input type="text" id="produto" class="input-field" disabled>
                    <button type="button" class="plus-icon" onclick="salvarCamposNoLocalStorage(); window.location.href='produto_pesquisa.html'">&#43;</button>
                </div>

                <label>*Código do Fornecedor:</label>
                <div class="input-container">
                    <input type="text" id="id_Fornecedor" class="input-field" disabled>
                    <button type="button" class="plus-icon" onclick="salvarCamposNoLocalStorage(); window.location.href='fornecedor_pesquisa.html'">&#43;</button>
                </div>

                <label>*Fornecedor:</label>
                <div class="input-container">
                    <input type="text" id="razao_Social" class="input-field"  disabled>
                    <button type="button" class="plus-icon" onclick="salvarCamposNoLocalStorage(); window.location.href='fornecedor_pesquisa.html'">&#43;</button>
                </div>

                <label>*Quantidade:</label>
                <div class="input-container">
                    <input type="number" step="0.01" maxlength="4" id="quantidade" required>
                </div>

                <label>*Preço de Custo:</label>
                <div class="input-container">
                    <div class="input-group">
                        <input type="number" step="0.01" maxlength="4" id="custo" name="custo" required>
                    </div>
                </div>
            </div>

            <div class="add-button">
                <button type="button" onclick="limparTabela()" id="clear">
                    <img src="../Fotos/delete-svgrepo-com(2).png">Limpar Tabela
                </button>
                <button type="button" onclick="adicionarProduto()" id="add">
                    <img src="../Fotos/plus.png">Adicionar
                </button>
            </div>
        </form>
    </div>

     <table id="resultadoTabela" cellspacing="0" style="display: none;">
        <thead>
             <tr>
                <th>COD</th>
                <th>Produto</th>
                <th>Fornecedor</th>
                <th>P.Custo</th>
                <th>QTD</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    </div>

    <p id="mensagemSucesso" style="font-size: 18px; background-color: green; color: whitesmoke;"></p>
    <p id="mensagemErro" style="font-size: 18px; background-color: red; color: whitesmoke;"></p>

    <div class="footer">
        <div class="search-link">
            <button id="back" onclick="window.location.href='Entrada.html'">
                <img src="../Fotos/corner-down-left-svgrepo-com.png">Voltar
            </button>
        </div>
        <div class="logo">
            <img src="../Fotos/Emporio maxx s-fundo.png" alt="Empório Maxx Logo">
        </div>
        <div>
            <button onclick="salvarProdutos()" id="save">
                <img src="../Fotos/check.png">Salvar
            </button>
        </div>
    </div>
</body>
</html>
